// Code generated by openapi sdkgen; DO NOT EDIT.

package services

import (
	"context"
	"encoding/json"

	"github.com/tidwall/gjson"
	"go.uber.org/zap"
	"resty.dev/v3"

	"{{.ModulePath}}/models"
)

// {{.Service.Name}}Service provides access to {{.Service.Name}} API operations.
type {{.Service.Name}}Service struct {
	restyClient *resty.Client
	logger      *zap.Logger
}

// New{{.Service.Name}}Service creates a new {{.Service.Name}}Service instance.
func New{{.Service.Name}}Service(restyClient *resty.Client, logger *zap.Logger) *{{.Service.Name}}Service {
	return &{{.Service.Name}}Service{
		restyClient: restyClient,
		logger:      logger,
	}
}
{{range .Service.Methods}}

{{- if .Comment}}
// {{.Name}} {{.Comment}}
{{- else}}
// {{.Name}} executes the {{.HTTPMethod}} {{.Path}} operation.
{{- end}}
func (s *{{$.Service.Name}}Service) {{.Name}}(ctx context.Context{{range .PathParams}}, {{.GoName}} {{.GoType}}{{end}}{{if .HasRequestBody}}, req {{.RequestBodyType}}{{end}}) ({{if .ResponseType}}{{.ResponseType}}, {{end}}error) {
	r := s.restyClient.R().
		SetContext(ctx)
{{- range .PathParams}}
	r.SetPathParam("{{.Name}}", {{.GoName}})
{{- end}}
{{- range .QueryParams}}
	{{- if .Required}}
	r.SetQueryParam("{{.Name}}", {{.GoName}})
	{{- end}}
{{- end}}
{{- if .HasRequestBody}}
	r.SetBody(req)
{{- end}}

	resp, err := r.{{.HTTPMethod | methodFunc}}("{{.Path}}")

	var data gjson.Result
	if resp != nil {
		data = gjson.ParseBytes(resp.Bytes())
	}
	if err != nil {
		s.logger.Error("error while calling {{.Name}}",
			zap.Error(err),
			zap.Any("response", data.Value()),
		)
		return {{if .ResponseType}}{{.ResponseType | zeroValue}}, {{end}}err
	}
{{- if .ResponseType}}
	{{- if .ResponseWrapper}}

	raw := data.Get("{{.ResponseWrapper}}").Raw
	{{- else}}

	raw := data.Raw
	{{- end}}

	var result {{.ResponseType | baseType}}
	if err := json.Unmarshal([]byte(raw), &result); err != nil {
		s.logger.Error("error while unmarshalling {{.Name}} response",
			zap.Error(err),
			zap.Any("response", data.Value()),
		)
		return {{.ResponseType | zeroValue}}, err
	}

	result.Raw = raw
	return result, nil
{{- else}}

	return nil
{{- end}}
}
{{- end}}
